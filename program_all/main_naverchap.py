# -*- coding: utf-8 -*-
import json
import random
import time
from pathlib import Path
from urllib.parse import quote

from playwright.sync_api import sync_playwright

PROFILE_DIR = Path("./chrome_profile_naver")
PROFILE_DIR.mkdir(parents=True, exist_ok=True)

BASE_URL = "https://msearch.shopping.naver.com/search/all?vertical=search&query="


def build_search_url(keyword):
    return BASE_URL + quote(keyword)


def get_next_data(page):
    # âœ… í•µì‹¬: NEXT_DATAê°€ ì•ˆ ëœ¨ë©´(íƒ€ì„ì•„ì›ƒ) ìº¡ì± /ë³´ì•ˆí™•ì¸ì¼ í™•ë¥ ì´ ë†’ìŒ
    page.wait_for_selector("#__NEXT_DATA__", state="attached", timeout=15000)
    raw = page.locator("#__NEXT_DATA__").text_content()
    raw = (raw or "").strip()
    if not raw:
        raise RuntimeError("__NEXT_DATA__ ë‚´ìš©ì´ ë¹„ì–´ìˆìŒ")
    return json.loads(raw)


def print_categories(keyword, data):
    pp = (((data or {}).get("props") or {}).get("pageProps") or {})

    # 1) 1ìˆœìœ„: categoryNames
    category = pp.get("categoryNames")
    if category:
        print("\nâœ… [{}] categoryNames".format(keyword))
        for k in category:
            print("{}: {}".format(k, category[k]))
        return

    # 2) 2ìˆœìœ„: cmp.category1~4 top1
    cmp_ = pp.get("cmp") or {}
    printed = False

    for key in ["category1", "category2", "category3", "category4"]:
        block = cmp_.get(key) or {}
        cats = block.get("categories") or []
        if cats:
            if not printed:
                print("\nâœ… [{}] cmp categories(top1)".format(keyword))
                printed = True
            top = cats[0] or {}
            print("{}: {} {}".format(key, top.get("id", ""), top.get("name", "")))

    if not printed:
        print("\nâŒ [{}] ì¹´í…Œê³ ë¦¬ ì—†ìŒ".format(keyword))


def ensure_not_blocked(page, url):
    # âœ… í•µì‹¬: ë§‰í˜”ìœ¼ë©´(ìº¡ì± /ë³´ì•ˆí™•ì¸) ì‚¬ëŒì´ í’€ê³  ê³„ì†
    # - NEXT_DATA ê¸°ë‹¤ë¦¬ë‹¤ê°€ ì‹¤íŒ¨í•˜ë©´ ìº¡ì± ë¡œ ê°„ì£¼
    try:
        data = get_next_data(page)
        return data
    except Exception:
        print("\nğŸ›¡ï¸ ìº¡ì± /ë³´ì•ˆí™•ì¸ ê°€ëŠ¥ì„±.")
        print("ğŸ‘‰ ë¸Œë¼ìš°ì €ì—ì„œ ìº¡ì± /ë³´ì•ˆí™•ì¸ì„ ì™„ë£Œí•œ ë’¤ Enter ì¹˜ì„¸ìš”.\n")
        input()
        page.goto(url, wait_until="domcontentloaded")
        page.wait_for_timeout(1200)
        # ë‹¤ì‹œ ì‹œë„
        return get_next_data(page)


def run(keywords):
    with sync_playwright() as p:
        ctx = p.chromium.launch_persistent_context(
            user_data_dir=str(PROFILE_DIR),
            channel="chrome",
            headless=False,
            viewport=None,
            args=["--start-maximized"],
            locale="ko-KR",
        )

        page = ctx.new_page()

        for kw in keywords:
            url = build_search_url(kw)
            print("\nğŸš€ {} ì ‘ì†".format(kw))

            page.goto(url, wait_until="domcontentloaded")
            page.wait_for_timeout(1200)

            data = ensure_not_blocked(page, url)
            print_categories(kw, data)

            delay = random.uniform(2.0, 3.0)
            print("\nâ³ {:.2f}ì´ˆ ëŒ€ê¸°...\n".format(delay))
            time.sleep(delay)

        ctx.close()


if __name__ == "__main__":
    keywords = ["ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤","ì½”ì¹´ì½œë¼", "í©ì‹œ", "í™˜íƒ€", "ì‚¬ì´ë‹¤", "ì›°ì¹˜ìŠ¤"]
    run(keywords)
